<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Ssrc C++/Lua/Perl/Python/Ruby Bindings for Spread API: Mailbox.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">  
</head><body bgcolor="#ffffff">
<div style="text-align: left; clear: both;">
<a href="http://www.savarese.com/"><img src="logoSmall.jpg"
alt="Savarese Software Research Corporation" width="144" height="36" border="0" align="top"
hspace="0" vspace="0"></img></a>
<br clear="all" />
</div>

<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7512ac95179c9c3704912cd55194388a.html">ssrc</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_c06a34e47a06b6ac4c1000cf3ecf6c64.html">spread</a>
  </div>
</div>
<div class="contents">
<h1>Mailbox.cc</h1><a href="a00021.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright 2006,2007 Savarese Software Research Corporation</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span>
<a name="l00006"></a>00006 <span class="comment"> * you may not use this file except in compliance with the License.</span>
<a name="l00007"></a>00007 <span class="comment"> * You may obtain a copy of the License at</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *     http://www.savarese.com/software/ApacheLicense-2.0</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * Unless required by applicable law or agreed to in writing, software</span>
<a name="l00012"></a>00012 <span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<a name="l00013"></a>00013 <span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00014"></a>00014 <span class="comment"> * See the License for the specific language governing permissions and</span>
<a name="l00015"></a>00015 <span class="comment"> * limitations under the License.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;<a class="code" href="a00022.html" title="This header defines the Mailbox class.">ssrc/spread/Mailbox.h</a>&gt;</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <a class="code" href="a00019.html#ce1c55468db474ed956a52e5d0ea2b4e">__BEGIN_NS_SSRC_SPREAD</a>
<a name="l00021"></a>00021 
<a name="l00026"></a>00026 <span class="keyword">const</span> Timeout <a class="code" href="a00007.html#c383c61b0e9488d278df1540dfd9325e" title="A constant denoting a timeout of zero seconds and zero microseconds.">Mailbox::ZeroTimeout</a>(0, 0);
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 
<a name="l00053"></a><a class="code" href="a00007.html#b13e12ddb3c113fe1eb146d439bf531c">00053</a> <a class="code" href="a00007.html#b13e12ddb3c113fe1eb146d439bf531c" title="Creates a Mailbox configured with the specified parameters.">Mailbox::Mailbox</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp; connection, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; name,
<a name="l00054"></a>00054                  <span class="keyword">const</span> <span class="keywordtype">bool</span> group_membership, <span class="keyword">const</span> <a class="code" href="a00011.html" title="Timeout is a simple wrapper around Sptread::sp_time the Spread C API&amp;#39;s Spread::sp_time...">Timeout</a> &amp; timeout,
<a name="l00055"></a>00055                  <span class="keyword">const</span> <a class="code" href="a00007.html#8e3be2fa17ee151c83138e8b7a9e1b47" title="The Priority enumeration defines the priority levels for establishing a mailbox connection...">Priority</a> priority)
<a name="l00056"></a>00056   SSRC_DECL_THROW(<a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058   <span class="keywordtype">int</span> result;
<a name="l00059"></a>00059   <a class="code" href="a00028.html#3de9a39e07d8e3c008ec8f16570ec488" title="This is an internal typedef not meant for use in end-user code.">Spread::group_type</a> private_group;
<a name="l00060"></a>00060 
<a name="l00061"></a>00061   result =
<a name="l00062"></a>00062     Spread::SP_connect_timeout(connection.c_str(),
<a name="l00063"></a>00063                                (name.size() == 0 ? 0 : name.c_str()), priority,
<a name="l00064"></a>00064                                group_membership, &amp;_mbox, private_group,
<a name="l00065"></a>00065                                timeout);
<a name="l00066"></a>00066 
<a name="l00067"></a>00067   <span class="keywordflow">if</span>(result != <a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c1be9564fa0a13c345ef3f072f2a7c26a">Error::AcceptSession</a>)
<a name="l00068"></a>00068     <span class="keywordflow">throw</span> <a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>(result);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070   _connection = connection;
<a name="l00071"></a>00071   _group_membership = group_membership;
<a name="l00072"></a>00072   _private_group = private_group;
<a name="l00073"></a>00073   _name = <a class="code" href="a00030.html#56762346a675ed7f806eecb6c4fbe14c" title="Splits a private group name into its private name and process name components.">split_private_group</a>(_private_group).first;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075   _drop_receive  = <span class="keyword">false</span>;
<a name="l00076"></a>00076   _killed        = <span class="keyword">false</span>;
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00088"></a><a class="code" href="a00007.html#0e165da365ea2e27290f292c7000ca40">00088</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#8fed35d438f863b9acc539984913545f" title="Same as send(message, _groups) where _groups is the internal GroupList containing...">Mailbox::send</a>(<span class="keyword">const</span> <a class="code" href="a00010.html" title="ScatterMessage is a reusable container of multiple in-place data buffers.">ScatterMessage</a> &amp; message, <span class="keyword">const</span> <a class="code" href="a00006.html" title="GroupList is a container for Spread group names.">GroupList</a> &amp; groups)
<a name="l00089"></a>00089   SSRC_DECL_THROW(<a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>)
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091   <span class="keywordtype">int</span> result;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   result =
<a name="l00094"></a>00094     Spread::SP_multigroup_scat_multicast(_mbox, message.service(),
<a name="l00095"></a>00095                                          groups.size(), groups.groups(),
<a name="l00096"></a>00096                                          message.type(), message.scatter());
<a name="l00097"></a>00097   <span class="keywordflow">if</span>(result &lt; 0)
<a name="l00098"></a>00098     <span class="keywordflow">throw</span> <a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>(result);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100   <span class="keywordflow">return</span> result;
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00106"></a><a class="code" href="a00007.html#2f46a9af67ca070dba7539ad47def1c8">00106</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#8fed35d438f863b9acc539984913545f" title="Same as send(message, _groups) where _groups is the internal GroupList containing...">Mailbox::send</a>(<span class="keyword">const</span> <a class="code" href="a00009.html" title="Message is a reusable and resizable data buffer for sending and receiving messages...">Message</a> &amp; message, <span class="keyword">const</span> <a class="code" href="a00006.html" title="GroupList is a container for Spread group names.">GroupList</a> &amp; groups)
<a name="l00107"></a>00107   SSRC_DECL_THROW(<a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>)
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109   clear_message_parts();
<a name="l00110"></a>00110   add_message_part(message);
<a name="l00111"></a>00111   _scatter.set_type(message.type());
<a name="l00112"></a>00112   _scatter.set_service(message.service());
<a name="l00113"></a>00113   <span class="keywordflow">return</span> send(_scatter, groups);
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00120"></a><a class="code" href="a00007.html#8fed35d438f863b9acc539984913545f">00120</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#8fed35d438f863b9acc539984913545f" title="Same as send(message, _groups) where _groups is the internal GroupList containing...">Mailbox::send</a>(<span class="keyword">const</span> <a class="code" href="a00009.html" title="Message is a reusable and resizable data buffer for sending and receiving messages...">Message</a> &amp; message, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp; group)
<a name="l00121"></a>00121   SSRC_DECL_THROW(<a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123   clear_groups();
<a name="l00124"></a>00124   add_group(group);
<a name="l00125"></a>00125   clear_message_parts();
<a name="l00126"></a>00126   add_message_part(message);
<a name="l00127"></a>00127   _scatter.set_type(message.type());
<a name="l00128"></a>00128   _scatter.set_service(message.service());
<a name="l00129"></a>00129   <span class="keywordflow">return</span> send(_scatter, _groups);
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00163"></a><a class="code" href="a00007.html#5444b548ad0746d0a22d6c5fd33bc532">00163</a> <span class="keywordtype">int</span> <a class="code" href="a00007.html#c169b3da5ef54fd28d308a6b76a29847" title="Same as receive(_scatter, _groups), where _scatter and _groups are the internal ScatterMessage...">Mailbox::receive</a>(<a class="code" href="a00010.html" title="ScatterMessage is a reusable container of multiple in-place data buffers.">ScatterMessage</a> &amp; message, <a class="code" href="a00006.html" title="GroupList is a container for Spread group names.">GroupList</a> &amp; groups)
<a name="l00164"></a>00164   SSRC_DECL_THROW(<a class="code" href="a00003.html" title="BufferSizeError is a container for a BufferTooShort or GroupTooShort errror, reporting...">BufferSizeError</a>, <a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166   <span class="keywordtype">int</span> result, num_groups, endian_mismatch;
<a name="l00167"></a>00167   <a class="code" href="a00001.html#ffacef3cc703a0f414d71bf8f247def9" title="Defines the type for 16-bit message type identifiers.">BaseMessage::message_type</a> type;
<a name="l00168"></a>00168   <a class="code" href="a00001.html#46cb6143e4980097a432fde6a96a8203" title="Defines the type for specifying service types.">BaseMessage::service_type</a> stype;
<a name="l00169"></a>00169   <a class="code" href="a00028.html#3de9a39e07d8e3c008ec8f16570ec488" title="This is an internal typedef not meant for use in end-user code.">Spread::group_type</a> sender;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171   groups.resize(groups.capacity());
<a name="l00172"></a>00172   message.init_pre_receive();
<a name="l00173"></a>00173 
<a name="l00174"></a>00174  try_again:
<a name="l00175"></a>00175   type = 0, num_groups = 0, endian_mismatch = 0;
<a name="l00176"></a>00176   stype = (_drop_receive ? <a class="code" href="a00001.html#ad62040d6f025819c245c743f43ce000358864f24b36e4181a94aeb4bdf0324b">BaseMessage::DropReceive</a> : 0);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178   result =
<a name="l00179"></a>00179     Spread::SP_scat_receive(_mbox, &amp;stype, sender, groups.size(), &amp;num_groups,
<a name="l00180"></a>00180                             groups.groups(), &amp;type, &amp;endian_mismatch,
<a name="l00181"></a>00181                             message.scatter());
<a name="l00182"></a>00182   <span class="keywordflow">if</span>(!_drop_receive) {
<a name="l00183"></a>00183     <span class="keywordflow">if</span>(result == <a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c7f2812be784ffcb83ebca7a910bc6091">Error::GroupsTooShort</a>) {
<a name="l00184"></a>00184       <span class="keywordflow">if</span>(num_groups &lt; 0) {
<a name="l00185"></a>00185         groups.resize(-num_groups);
<a name="l00186"></a>00186         <span class="keywordflow">if</span>(endian_mismatch == 0)
<a name="l00187"></a>00187           <span class="keywordflow">goto</span> try_again;
<a name="l00188"></a>00188         <span class="keywordflow">else</span>
<a name="l00189"></a>00189           result = <a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c91f9296500db661d70bef3329427b39a">Error::BufferTooShort</a>;
<a name="l00190"></a>00190       } <span class="keywordflow">else</span>
<a name="l00191"></a>00191         <span class="keywordflow">throw</span> <a class="code" href="a00003.html" title="BufferSizeError is a container for a BufferTooShort or GroupTooShort errror, reporting...">BufferSizeError</a>(<a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c7f2812be784ffcb83ebca7a910bc6091">Error::GroupsTooShort</a>, -num_groups);
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="keywordflow">if</span>(result == <a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c91f9296500db661d70bef3329427b39a">Error::BufferTooShort</a>) {
<a name="l00195"></a>00195       <span class="keywordflow">if</span>(num_groups &lt; 0)
<a name="l00196"></a>00196         groups.resize(-num_groups);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198       <span class="keywordflow">if</span>(message.count_message_objects() &gt; 0 &amp;&amp; endian_mismatch &lt; 0) {
<a name="l00199"></a>00199         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> last_message = message.count_message_objects() - 1;
<a name="l00200"></a>00200         <a class="code" href="a00009.html" title="Message is a reusable and resizable data buffer for sending and receiving messages...">Message</a> *m = message.message(last_message);
<a name="l00201"></a>00201         <span class="comment">// endian_mismatch stores negative of incoming message size</span>
<a name="l00202"></a>00202         message.resize_message(last_message,
<a name="l00203"></a>00203                                - endian_mismatch - message.size() + m-&gt;<a class="code" href="a00009.html#7b7de1dfef0a3c08e8b5bca178ace2a1" title="Returns the number of bytes in the message.">size</a>());
<a name="l00204"></a>00204         <span class="keywordflow">goto</span> try_again;
<a name="l00205"></a>00205       } <span class="keywordflow">else</span>
<a name="l00206"></a>00206         <span class="keywordflow">throw</span> <a class="code" href="a00003.html" title="BufferSizeError is a container for a BufferTooShort or GroupTooShort errror, reporting...">BufferSizeError</a>(<a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c91f9296500db661d70bef3329427b39a">Error::BufferTooShort</a>, -endian_mismatch);
<a name="l00207"></a>00207     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(result &lt; 0)
<a name="l00208"></a>00208       <span class="keywordflow">throw</span> <a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>(result);
<a name="l00209"></a>00209   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(result &lt; 0 &amp;&amp; result != <a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c7f2812be784ffcb83ebca7a910bc6091">Error::GroupsTooShort</a> &amp;&amp;
<a name="l00210"></a>00210             result != <a class="code" href="a00005.html#834710a5b2002899703f98b98edad49c91f9296500db661d70bef3329427b39a">Error::BufferTooShort</a>)
<a name="l00211"></a>00211     <span class="keywordflow">throw</span> <a class="code" href="a00005.html" title="Error is a container for a Spread error code and is thrown by the library in only...">Error</a>(result);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   message.set_type(type);
<a name="l00214"></a>00214   message.set_service(stype);
<a name="l00215"></a>00215   message.set_sender(sender);
<a name="l00216"></a>00216   message.set_endian_mismatch(endian_mismatch != 0);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   groups.resize(num_groups);
<a name="l00219"></a>00219   message.init_post_receive(result);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <span class="keywordflow">return</span> result;
<a name="l00222"></a>00222 }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <a class="code" href="a00019.html#f075ee1a7a8c2e28536978317b0f4aff">__END_NS_SSRC_SPREAD</a>
</pre></div></div>
<hr />
<div style="float: left;">
<a href="http://www.savarese.com/"><img src="logoSmall.jpg"
alt="Savarese Software Research Corporation" width="144" height="36" border="0" align="top"
hspace="0" vspace="0"></img></a>
</div>
<div style="text-align:right">
Copyright &#169; 2006-2009 Savarese Software Research Corporation. All rights reserved.
</div>
</body></html>
